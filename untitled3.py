# -*- coding: utf-8 -*-
"""Untitled1.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1C7go9EXTJ30YnkWTTgnP2Y4ve9mYa_x5
"""

import streamlit as st
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from sklearn.metrics import mean_absolute_percentage_error, mean_squared_error

# ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñ‹
st.set_page_config(page_title="ĞŸÑ€Ğ¾Ğ³Ğ½Ğ¾Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ", layout="wide")
st.title("ğŸ“ˆ Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹ Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ")

# === Ğ—ĞĞ“Ğ Ğ£Ğ—ĞšĞ Ğ”ĞĞĞĞ«Ğ¥ ===
@st.cache_data
def load_data():
    data = {
        'Prophet': pd.read_csv("forecast_prophet.csv"),
        'RNN': pd.read_csv("forecast_rnn.csv"),
        'FNN': pd.read_csv("forecast_fnn.csv"),
        'FCNN': pd.read_csv("forecast_fcnn.csv"),
        'XGBoost': pd.read_csv("forecast_xgb.csv"),
        'ĞĞ½ÑĞ°Ğ¼Ğ±Ğ»ÑŒ': pd.read_csv("forecast_ensemble.csv")
    }
    for key in data:
        data[key]['ds'] = pd.to_datetime(data[key]['ds'])
    return data

all_data = load_data()

# === Ğ’Ğ«Ğ‘ĞĞ  ĞœĞĞ”Ğ•Ğ›Ğ˜ ===
method = st.radio("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¼ĞµÑ‚Ğ¾Ğ´ Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ:", list(all_data.keys()))

df = all_data[method]

# === Ğ’Ğ«Ğ‘ĞĞ  Ğ”Ğ˜ĞĞŸĞĞ—ĞĞĞ Ğ”ĞĞ¢ ===
start_date = df['ds'].min()
end_date = df['ds'].max()
date_range = st.date_input("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½ Ğ´Ğ°Ñ‚:", [start_date, end_date])

if len(date_range) != 2:
    st.warning("Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½ÑƒÑ Ğ¸ ĞºĞ¾Ğ½ĞµÑ‡Ğ½ÑƒÑ Ğ´Ğ°Ñ‚Ñƒ.")
    st.stop()

start, end = pd.to_datetime(date_range[0]), pd.to_datetime(date_range[1])
df_plot = df[(df['ds'] >= start) & (df['ds'] <= end)].copy()

# === Ğ’Ğ«Ğ‘ĞĞ  ĞšĞĞ›ĞĞĞĞš Ğ”Ğ›Ğ¯ ĞŸĞ ĞĞ“ĞĞĞ—Ğ Ğ˜ Ğ˜Ğ¡Ğ¢Ğ˜ĞĞĞ«Ğ¥ Ğ—ĞĞĞ§Ğ•ĞĞ˜Ğ™ ===
if method == 'Prophet':
    y_true = df_plot['y']
    y_pred = df_plot['yhat']
elif method == 'RNN':
    y_true = df_plot['y_true_rnn']
    y_pred = df_plot['y_pred_rnn']
else:
    y_true = df_plot['y_true_rnn']
    y_pred = df_plot['y_pred_rnn']  # Ğ’Ğ°Ğ¶Ğ½Ğ¾: y_pred_rnn Ğ² Ğ´Ñ€ÑƒĞ³Ğ¸Ñ… Ğ¼Ğ¾Ğ´ĞµĞ»ÑÑ…

# === ĞœĞ•Ğ¢Ğ Ğ˜ĞšĞ˜ ===
mape = mean_absolute_percentage_error(y_true, y_pred) * 100
rmse = np.sqrt(mean_squared_error(y_true, y_pred))

st.subheader("ğŸ“Š ĞœĞµÑ‚Ñ€Ğ¸ĞºĞ¸")
col1, col2 = st.columns(2)
col1.metric("MAPE (%)", f"{mape:.2f}")
col2.metric("RMSE", f"{rmse:.2f}")

# === Ğ“Ğ ĞĞ¤Ğ˜Ğš ===
st.subheader("ğŸ“‰ Ğ“Ñ€Ğ°Ñ„Ğ¸Ğº Ğ¿Ñ€Ğ¾Ğ³Ğ½Ğ¾Ğ·Ğ°")
fig, ax = plt.subplots(figsize=(12, 5))

# Ğ¤Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ
ax.plot(df_plot['ds'], y_true, label='Ğ¤Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ', color='black')

# ĞŸÑ€Ğ¾Ğ³Ğ½Ğ¾Ğ·
if method == 'Prophet':
    ax.plot(df_plot['ds'], y_pred, label='ĞŸÑ€Ğ¾Ğ³Ğ½Ğ¾Ğ· Prophet', color='blue')
    if 'yhat_lower' in df_plot and 'yhat_upper' in df_plot:
        ax.fill_between(df_plot['ds'], df_plot['yhat_lower'], df_plot['yhat_upper'],
                        color='blue', alpha=0.2, label='95% Ğ¸Ğ½Ñ‚ĞµÑ€Ğ²Ğ°Ğ»')
else:
    ax.plot(df_plot['ds'], y_pred, label=f'ĞŸÑ€Ğ¾Ğ³Ğ½Ğ¾Ğ· {method}', linestyle='--', color='green')

ax.set_xlabel("Ğ”Ğ°Ñ‚Ğ°")
ax.set_ylabel("Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ")
ax.legend()
ax.grid(True)
st.pyplot(fig)

# === Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ===
with st.expander("ğŸ“‹ ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…"):
    st.dataframe(df_plot)