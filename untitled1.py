# -*- coding: utf-8 -*-
"""Untitled1.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1C7go9EXTJ30YnkWTTgnP2Y4ve9mYa_x5
"""

import streamlit as st
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
from sklearn.metrics import mean_absolute_percentage_error, mean_squared_error

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹
st.set_page_config(page_title="ÐŸÑ€Ð¾Ð³Ð½Ð¾Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ", layout="wide")

st.title("ðŸ“ˆ Ð¡Ñ€Ð°Ð²Ð½ÐµÐ½Ð¸Ðµ Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹ Ð¿Ñ€Ð¾Ð³Ð½Ð¾Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ")

# === Ð—ÐÐ“Ð Ð£Ð—ÐšÐ CSV ===
@st.cache_data
def load_data():
    df_prophet = pd.read_csv("forecast_prophet.csv", parse_dates=["ds"])
    df_rnn = pd.read_csv("forecast_rnn.csv", parse_dates=["ds"])
    return df_prophet, df_rnn

df_prophet, df_rnn = load_data()

# === ÐžÐ‘ÐªÐ•Ð”Ð˜ÐÐ•ÐÐ˜Ð• Ð”ÐÐÐÐ«Ð¥ ===
forecast = pd.merge(df_prophet, df_rnn, on="ds", how="inner")

# === Ð’Ð«Ð‘ÐžÐ  ÐœÐ•Ð¢ÐžÐ”Ð ===
method = st.radio("ðŸ” Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¼ÐµÑ‚Ð¾Ð´ Ð¿Ñ€Ð¾Ð³Ð½Ð¾Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ:", ['Prophet', 'RNN'])

# === Ð’Ð«Ð‘ÐžÐ  Ð”Ð˜ÐÐŸÐÐ—ÐžÐÐ Ð”ÐÐ¢ ===
start_date = forecast['ds'].min()
end_date = forecast['ds'].max()

date_range = st.date_input("ðŸ“… Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½ Ð´Ð°Ñ‚:", [start_date, end_date])

if len(date_range) != 2:
    st.warning("Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð½Ð°Ñ‡Ð°Ð»ÑŒÐ½ÑƒÑŽ Ð¸ ÐºÐ¾Ð½ÐµÑ‡Ð½ÑƒÑŽ Ð´Ð°Ñ‚Ñƒ.")
    st.stop()

start, end = pd.to_datetime(date_range[0]), pd.to_datetime(date_range[1])
df_plot = forecast[(forecast['ds'] >= start) & (forecast['ds'] <= end)].copy()

# === Ð ÐÐ¡Ð§Ð•Ð¢ ÐœÐ•Ð¢Ð Ð˜Ðš ===
if method == 'Prophet':
    y_true = df_plot['y']
    y_pred = df_plot['yhat']
else:
    y_true = df_plot['y_true_rnn']
    y_pred = df_plot['y_pred_rnn']

# Ð—Ð°Ñ‰Ð¸Ñ‚Ð° Ð¾Ñ‚ NaN
if y_true.isnull().any() or y_pred.isnull().any():
    st.error("ÐžÑˆÐ¸Ð±ÐºÐ°: ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ñ‹ Ð¿Ñ€Ð¾Ð¿ÑƒÑ‰ÐµÐ½Ð½Ñ‹Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ð² Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð¾Ð¼ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½Ðµ.")
    st.stop()

mape = mean_absolute_percentage_error(y_true, y_pred) * 100
rmse = np.sqrt(mean_squared_error(y_true, y_pred))

# === Ð’Ð«Ð’ÐžÐ” ÐœÐ•Ð¢Ð Ð˜Ðš ===
st.subheader("ðŸ“Š ÐœÐµÑ‚Ñ€Ð¸ÐºÐ¸ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð°")
col1, col2 = st.columns(2)
col1.metric("MAPE (%)", f"{mape:.2f}")
col2.metric("RMSE", f"{rmse:.2f}")

# === Ð“Ð ÐÐ¤Ð˜Ðš ===
st.subheader("ðŸ“‰ Ð“Ñ€Ð°Ñ„Ð¸Ðº Ð¿Ñ€Ð¾Ð³Ð½Ð¾Ð·Ð°")

fig, ax = plt.subplots(figsize=(12, 5))
ax.plot(df_plot['ds'], y_true, label='Ð¤Ð°ÐºÑ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ', color='black')

if method == 'Prophet':
    ax.plot(df_plot['ds'], df_plot['yhat'], label='ÐŸÑ€Ð¾Ð³Ð½Ð¾Ð· Prophet', color='blue')
    ax.fill_between(df_plot['ds'], df_plot['yhat_lower'], df_plot['yhat_upper'],
                    color='blue', alpha=0.2, label='95% Ð¸Ð½Ñ‚ÐµÑ€Ð²Ð°Ð»')
else:
    ax.plot(df_plot['ds'], df_plot['y_pred_rnn'], label='ÐŸÑ€Ð¾Ð³Ð½Ð¾Ð· RNN', color='green', linestyle='--')

ax.set_xlabel("Ð”Ð°Ñ‚Ð°")
ax.set_ylabel("Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ")
ax.grid(True)
ax.legend()
st.pyplot(fig)

# === Ð¢ÐÐ‘Ð›Ð˜Ð¦Ð Ð”ÐÐÐÐ«Ð¥ ===
with st.expander("ðŸ“‹ Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ð¿Ñ€Ð¾Ð³Ð½Ð¾Ð·Ð¾Ð² Ð¸ Ñ„Ð°ÐºÑ‚Ð¾Ð²"):
    st.dataframe(df_plot[['ds', 'y', 'yhat', 'yhat_lower', 'yhat_upper', 'y_pred_rnn']])